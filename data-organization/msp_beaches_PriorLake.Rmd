---
title: "Prior Lake data organization code"
author: "Becky Forgrave"
date: "2025-08-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Packages to load --------------------------------------------------------

library(tidyverse)
library(googledrive)
library(readxl)
library(here)
library(FSA) # for geomean() function
library(janitor) # for row_to_names() fucntion



```

```{r download from Google Drive}

# drive_download( # download spreadsheet from google drive
#   file = as_id("https://drive.google.com/drive/folders/139YcvYH_dDmKBHu8UMGvYP3Y8ghrTTYl"),
#   path = here("MSP-beaches_PriorLake1_raw.csv"),
#   overwrite = TRUE   # this is helpful to make sure folks don't accidentally use a modified local version of the file
# )
# 
# path <- here("MSP-beaches_PriorLake1_csv.xlsx")
# 
# # doesn't work


```

```{r load in data from computer}

# path <- here("G:/Shared drives/MSP LTER - Public/Q2 - Lakes and Watersheds/Q2.2 - Lakes & Surface Waters/TCMA Lake Research/Research initiatives/Beaches/Received data/City of Prior Lake/spreadsheets")


# knitr::opts_knit$set(root.dir = "G:/Shared drives/MSP LTER - Public/Q2 - Lakes and Watersheds/Q2.2 - Lakes & Surface Waters/TCMA Lake Research/Research initiatives/Beaches")


path <- here("G:/Shared drives/MSP LTER - Public/Q2 - Lakes and Watersheds/Q2.2 - Lakes & Surface Waters/TCMA Lake Research/Research initiatives/Beaches/Received data/City of Prior Lake/spreadsheets/")

# can't get the above options working --> have to set path in each chunk below :/

```
# First dataset
```{r arrange and format colummns}

setwd(path)

prior2010 <- read.csv("Prior Lake Ecoli 2002-2010 tabular.csv") %>%
  rename(Date = Sample.Date) %>%
  rename(Watzl = Watzl.s) %>%
  mutate(Date = as.Date(Date, format = "%m/%d/%Y")) 


Expected <- length(which(prior2010[,2:3] == "<1")) +  length(which(prior2010 [,2:3] == "1")) # number of <1 and 1 in all data columns
# also works with random <10 in data

prior2010 <- prior2010 %>%
  mutate(
    across(
      .cols = 2:3,
      .fns = ~ str_replace(string = .x, pattern = "<1", replacement = "1")
    )
  )

# check that all converted correct
length(which(prior2010[,2:3] == "1"))  == Expected # True

# convert to numeric (removes "not tested")
prior2010 <- prior2010 %>%
  mutate(
    across(
      .cols = 2:3,
      .fns = as.numeric
    )
  )


str(prior2010)
summary(prior2010)


# make long
prior2010_long <- prior2010 %>%
  pivot_longer(
    cols = c(Sandpoint, Watzl),
    names_to = "beach",
    values_to = "ecoli"
  )

```


# Rest of data
```{r load in data}

setwd(path)

path = "G:/Shared drives/MSP LTER - Public/Q2 - Lakes and Watersheds/Q2.2 - Lakes & Surface Waters/TCMA Lake Research/Research initiatives/Beaches/Received data/City of Prior Lake/spreadsheets/"

# list of each file
files <- list.files(path = path, 
                           pattern = ".xlsx", 
                           all.files = FALSE  # no hidden files or lock files (if something is open in excel)
                           )

priordata = lapply(files, read_xlsx(skip=1)) # reads all data in as a list --> not working
  


# unlist and append

pl_raw <- data.frame()

for (i in 1:length(files)) {

    oneyear <- priordata[[i]] # select one year to manipulate
  numcols <- ncol(oneyear) # get number of columns in dataset

  # separate by beach
  sandpoint  <- oneyear %>%
    select(all_of(1:5)) %>%               # choose columnns for this beach
    row_to_names(row_number = 1) %>%      # move row 1 to headers
    rename(                               # remove spaces in column names
      "Sample1" = "Sample 1",
      "Sample2" = "Sample 2",
      "GeoMean30" = "Geometric Mean") %>%
    filter(!is.na(Sample1))  %>%                 # remove empty rows and notes rows
    mutate(BeachName = "Sand Point Beach") %>%
    mutate(Date = janitor::convert_to_date(Date)) # format date
  
  
  watzl <- oneyear %>%
    select(all_of(7:numcols)) %>% # select columns
    row_to_names(row_number = 1) %>%      # move row 1 to headers
    rename(                               # remove spaces in column names
      "Sample1" = "Sample 1",
      "Sample2" = "Sample 2",
      "GeoMean30" = "Geometric Mean") %>%
    filter(!is.na(Sample1))  %>%                 # remove empty rows and notes rows
    mutate(BeachName = "Watzl's Beach") %>%
    mutate(Date = janitor::convert_to_date(Date)) # format date
  
  
  oneyear_recombined <- rbind(sandpoint, watzl)

    # join to combined df
    pl_raw  <- rbind(pl_raw , oneyear_recombined)
}
  

# convert to numeric later (deal with <1)

# sometimes date, sometimes sample date
# also columns not always in same exact positon , just same relative position


```


# combine
```{r convert all values to numeric}

# Look at format of dfs----

str(pl)
summary(pl)

# Change values that are "<1" to 1--------

Expected <- length(which(pl[,3:9] == "<1")) +  length(which(pl[,3:9] == "1")) # number of <1 and 1 in all data columns

pl <- pl %>%
  mutate(
    across(
      .cols = 3:9,
      .fns = ~ str_replace(
        string = .x,
        pattern = "<1",
        replacement = "1"
      )
    )
  )

# check that all converted correct
length(which(pl[,3:9] == "1"))  == Expected # True



# convert numeric columns from chr --> num

pl <- pl %>%
  mutate(
    across(
      .cols = 3:10,
      .fns = as.numeric
    )
  )


str(pl)
summary(pl)

```

```{r calculate geometric means}


## pivot longer--------------------

pl_long <- pl %>%
  pivot_longer(
    cols = c(sample1, sample2),
    names_to = "SampleID",
    values_to = "Meas"
  )



# create new column to hold calculated values
pl_long$Ecoli_1dGM <- 0
pl_long$Ecoli_30dGM <- 0


# separate by beach for calculations------------------------------

sand <- pl_long %>%
  filter(BeachName == "Sand Point Beach")

  
for (i in 1:length(libbs$Date)) {
  
  intervalstart <- as.POSIXct(sand$Date[i] - 30) # start 30 days before sampling date
  intervalend <-  as.POSIXct(sand$Date[i])

  # select all E coli measurements for one day
  oneday <-  sand %>%
    filter(Date == intervalend)
  
  # calculate 1 day geometric mean and add it to column in df
  sand$Ecoli_1dGM[i] <- round(geomean(oneday$Meas, na.rm = TRUE), digits = 1)
  
  
  # select all E coli measurements in range
  span30d <-  sand %>%
    filter(Date >= intervalstart & Date <= intervalend)
  
  # calculate 30-day geometric mean and add it to column in df
  sand$Ecoli_30dGM[i] <- round(geomean(span30d$Meas, na.rm = TRUE), digits = 1)
  
}

sand <- sand %>%
  select(BeachName, Date, Ecoli_1dGM, Ecoli_30dGM) %>%
  distinct()




# separate by beach for calculations------------------

shady <- minnetonka_long %>%
  filter(BeachName == "Shady Oak Beach")


for (i in 1:length(shady$Date)) {
  
  intervalstart <- as.POSIXct(shady$Date[i] - 30) # start 30 days before sampling date
  intervalend <-  as.POSIXct(shady$Date[i])
  
  # select all E coli measurements for one day
  oneday <-  shady %>%
    filter(Date == intervalend)
  
  # calculate 1 day geometric mean and add it to column in df
  shady$Ecoli_1dGM[i] <- round(geomean(oneday$Meas, na.rm = TRUE), digits = 1)
  
  
  # select all E coli measurements in range
  span30d <-  shady %>%
    filter(Date >= intervalstart & Date <= intervalend)
  
  # calculate 30-day geometric mean and add it to column in df
  shady$Ecoli_30dGM[i] <- round(geomean(span30d$Meas, na.rm = TRUE), digits = 1)
  
}

shady <- shady %>%
  select(BeachName, Date, Ecoli_1dGM, Ecoli_30dGM) %>%
  distinct()




minnetonka <- rbind(shady, libbs) # rewrites minntonka df

minnetonka <- minnetonka[!is.na(minnetonka$Ecoli_1dGM),] # remove any NAs in data



```

```{r fill additional columns}

# add columns to match master dataset--------------------
pl <- pl %>%
  mutate(
    Ecoli_units = "",
    ClosureYN = "N",
    ClosureReason = NA,
    MonitoringOrg = "PriorLake"
    DOW = "70002600"  # Lower Prior Lake
  )


# fill in units column-----------------------------
# 2002 - 2010 is in cfu
# 2014 - 2015 is in mpn
pl <- pl %>%
   Ecoli_units = if_else(
      condition = Date > "2014-01-01",
      true = "cfu",
      false = "mpn")
  



# find a label beach closures-------------------------------

pl <- pl %>%
  mutate(
    ClosureYN = if_else(
      condition = Ecoli_1dGM > 1260,
      true = "Y",
      false = "N")
  ) %>%
  mutate(
    ClosureReason = if_else(
      condition = Ecoli_1dGM > 1260,
      true = "ecoli_1dayGM",
      false = NA)
  ) %>% 
  mutate(
    ClosureYN = if_else(
      condition = Ecoli_30dGM > 126,
      true = "Y",
      false = "N")
  ) %>%
  mutate(
    ClosureReason = if_else(
      condition = Ecoli_30dGM > 126,
      true = "ecoli_30dayGM",
      false = NA)
  ) 


```

```{r save data}

# save to GitHub
write_csv(pl, file = here("MSP-beaches_PriorLake_clean.csv"))

# upload to Google Drive 


```

